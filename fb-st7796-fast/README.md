# Повышение скорости работы MKS TS35-R

**Актуально для OrangePi3 LTS**. На Raspberry PI экран и так работает на высокой частоте SPI

## Введение

Наверняка обладатели 3D-принтера Flying Bear Ghost 6, перешедшие на Klipper, и настроившие Klipperscreen для штатного 3.5" TFT-экрана, обратили внимание
на невысокую скорость обновления/отрисовки картинки, как следствие - тормознутость на отклик на нажатие тачскрина.

Многие решили эту проблему кардинально - подключением HDMI-экрана 5 или 7 дюймов.

Если пользователь ещё не успел нанести ущерб своему кошельку, а также внешнему виду принтера, предлагается дать ещё один шанс штатному 3.5" экрану,
подняв частоту кадров путём повышения скорости SPI-интерфейса, по которому передаётся картинка от OrangePi3 LTS на дисплей.

## Системные требования

Данное руководство предполагает, что штатный экран уже **подключен и настроен** по методике Сергея Терентьева https://github.com/Sergey1560/fb4s_howto/blob/master/mks_ts35/ к **OrangePi3 LTS**, и исходники драйвера были скачаны по пути ```~/fb_st7796s/```


## Описание проблемы

В dts-оверлее https://github.com/Sergey1560/fb_st7796s/blob/master/dts/sun50i-h6-st7796s.dts#L22 для канала дисплея запрошена частота шины SPI не более 10МГц,
фактически устанавливается около 6 МГц (предположительно, 6.25МГц, нужна дополнительная проверка).

В даташите на ST7796 приведена максимальная тактовая частота записи данных по интерфейсу SPI 62.5МГц

Максимальная тактовая частота SPI, выдаваемая "апельсинкой", 50 МГц. Запустить TFT на этой частоте получилось, но осциллограф показывает, что порт линии SCK едва вытягивает линию, чтобы работать без сбоев
(завалены фронты, просела амплитуда). На частоте 25 МГц сигнал SCK более приемлемый для стабильной работы.

## Перенастройка частоты SPI

Меняем строку 22 в файле ```~/fb_st7796s/dts/sun50i-h6-st7796s.dts ```
```console
$ cd ~/fb_st7796s/dts
$ nano sun50i-h6-st7796s.dts
```

Находим в секции fragment@0 строку 

```spi-max-frequency = <10000000>;``` 

и меняем на 

```spi-max-frequency = <25000000>;```

Сохраняем изменения.

Компилируем оверлей и перезагружаемся

***ВНИМАНИЕ!*** Похожую строку, но с частотой 1МГц <1000000> в следующей секции НЕ МЕНЯЕМ! Она относится к тачскрину, 
и на скорость обновления не повлияет.

```console
$ sudo armbian-add-overlay sun50i-h6-st7796s.dts
$ sudo reboot
```

При перезагрузке видим ускорившуюся прокрутку сообщений системы инициализации, ощущаем радость бытия

***ВНИМАНИЕ!*** В зависимости от длины шлейфа дисплея и степени кучерявости Dupont-ов (если используются), частота 25 МГц может оказаться избыточной,
и на экране появятся графические артефакты, либо дисплей вообще не запустится. В таком случае можно попробовать поставить частоту 12.5 МГц:

```spi-max-frequency = <12500000>;```
